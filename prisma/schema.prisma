generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                @id @default(uuid())
  email                  String                @unique
  name                   String?
  createdAt              DateTime              @default(now())
  ghlAccessToken         String?
  ghlRefreshToken        String?
  ghlUserId              String?               @unique
  tokenExpiresAt         DateTime?
  updatedAt              DateTime              @updatedAt
  username               String                @unique
  password               String
  role                   UserRole              @default(SURVEYOR)
  status                 UserStatus            @default(ACTIVE)
  isEmailVerified        Boolean               @default(false)
  emailVerificationToken String?
  passwordResetToken     String?
  passwordResetExpires   DateTime?
  lastLoginAt            DateTime?
  ghlTeamId              String?
  ghlUserName            String?
  maxTravelTime          String?
  surveyorAreas          String[]              @default([])
  surveyorLocation       String?
  appointments           Appointment[]
  autoSaves              AutoSave[]
  calculatorProgress     CalculatorProgress[]
  opportunityOutcomes    OpportunityOutcome[]
  opportunityProgress    OpportunityProgress[]
  opportunities         Opportunity[]
  createdSurveys         Survey[]              @relation("SurveyCreator")
  surveys                Survey[]
  updatedSurveys         Survey[]              @relation("SurveyUpdater")
}

model Appointment {
  id               String            @id @default(uuid())
  scheduledAt      DateTime
  customerName     String
  customerPhone    String
  customerEmail    String?
  address          String
  status           AppointmentStatus
  ghlAppointmentId String?
  userId           String
  notes            String?
  sourceChannel    SourceChannel
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  user             User              @relation(fields: [userId], references: [id])
}

model OpportunityProgress {
  id               String            @id @default(uuid())
  ghlOpportunityId String            @unique
  userId           String
  currentStep      Int               @default(1)
  totalSteps       Int               @default(5)
  status           OpportunityStatus @default(IN_PROGRESS)
  startedAt        DateTime          @default(now())
  lastActivityAt   DateTime          @default(now())
  completedAt      DateTime?
  stepData         Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  contactAddress   String?
  contactPostcode  String?
  user             User              @relation(fields: [userId], references: [id])
  steps            OpportunityStep[]
}

model OpportunityStep {
  id                    String              @id @default(uuid())
  opportunityProgressId String
  stepNumber            Int
  stepType              StepType
  status                StepStatus          @default(PENDING)
  data                  Json?
  startedAt             DateTime?
  completedAt           DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  opportunityProgress   OpportunityProgress @relation(fields: [opportunityProgressId], references: [id], onDelete: Cascade)

  @@unique([opportunityProgressId, stepNumber])
}

model OpenSolarProject {
  id                 String   @id @default(uuid())
  opportunityId      String   @unique
  opensolarProjectId String
  projectName        String
  address            String?
  systems            Json
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Survey {
  id               String        @id @default(uuid())
  ghlOpportunityId String        @unique
  ghlUserId        String?
  page1            Json?
  page2            Json?
  page3            Json?
  page4            Json?
  page5            Json?
  page6            Json?
  page7            Json?
  page8            Json?
  status           SurveyStatus  @default(DRAFT)
  eligibilityScore Int?
  rejectionReason  String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  submittedAt      DateTime?
  approvedAt       DateTime?
  rejectedAt       DateTime?
  deletedAt        DateTime?
  isDeleted        Boolean       @default(false)
  createdBy        String
  updatedBy        String?
  createdByUser    User          @relation("SurveyCreator", fields: [createdBy], references: [id])
  user             User?         @relation(fields: [ghlUserId], references: [ghlUserId])
  updatedByUser    User?         @relation("SurveyUpdater", fields: [updatedBy], references: [id])
  images           SurveyImage[]
}

model SurveyImage {
  id           String   @id @default(uuid())
  surveyId     String
  fieldName    String
  fileName     String
  originalName String
  mimeType     String
  fileSize     Int
  filePath     String
  base64Data   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  survey       Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([fieldName])
}

model Signature {
  id            String   @id @default(uuid())
  opportunityId String
  signatureData String
  signedAt      DateTime
  signedBy      String?
  ipAddress     String?
  userAgent     String?
  filePath      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([opportunityId])
}

// Opportunity model - stores GHL opportunity data locally
model Opportunity {
  id                    String              @id @default(uuid())
  ghlOpportunityId      String              @unique
  name                  String              // Opportunity name/title
  userId                String?             // Assigned user/rep (from GHL assignedTo)
  assignedToGhlId       String?             // GHL user ID who is assigned
  assignedToName        String?             // Name of assigned rep
  
  // Customer/Contact information
  contactId             String?             // GHL contact ID
  customerName          String?             // Customer full name
  customerFirstName     String?             
  customerLastName      String?
  customerEmail         String?
  customerPhone         String?
  customerAddress       String?
  customerCity          String?
  customerState         String?
  customerPostcode      String?
  
  // Opportunity details
  monetaryValue         Float?              // Deal value
  status                String?              // GHL status (open, won, lost, etc.)
  pipelineId            String?             // GHL pipeline ID
  pipelineName          String?             // Pipeline name
  pipelineStageId       String?             // Current stage ID
  stageName             String?             // Current stage name
  
  // Outcome tracking (linked to OpportunityOutcome)
  outcome               OpportunityOutcomeType? // Current outcome (won/lost/cancelled/etc)
  
  // Metadata
  tags                  String[]            @default([]) // GHL tags
  notes                 String?             // Opportunity notes
  source                String?             // Source channel (AI, Manual, etc.)
  ghlData               Json?                // Full GHL opportunity data (for reference)
  
  // Timestamps
  ghlCreatedAt           DateTime?           // Created date from GHL
  ghlUpdatedAt           DateTime?           // Last updated from GHL
  lastSyncedAt           DateTime            @default(now()) // When we last synced from GHL
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  
  // Relations
  user                  User?               @relation(fields: [userId], references: [id])
  // outcomeRecord         OpportunityOutcome?  // Will add after syncing opportunities
  
  @@index([userId])
  @@index([ghlOpportunityId])
  @@index([contactId])
  @@index([outcome])
  @@index([status])
  @@index([pipelineStageId])
  @@index([lastSyncedAt])
  @@index([assignedToGhlId])
}

model OpportunityOutcome {
  id               String                 @id @default(uuid())
  ghlOpportunityId String                 @unique
  userId           String
  outcome          OpportunityOutcomeType
  value            Float?
  duration         Int?
  stageAtOutcome   String?
  notes            String?
  ghlUpdatedAt     DateTime?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  user             User                   @relation(fields: [userId], references: [id])
  // opportunity      Opportunity?           @relation(fields: [ghlOpportunityId], references: [ghlOpportunityId], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId])
  @@index([outcome])
  @@index([createdAt])
}

model AutoSave {
  id            String    @id @default(uuid())
  userId        String
  opportunityId String
  data          Json      @default("{}")
  lastSavedAt   DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  isDeleted     Boolean   @default(false)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId, isDeleted])
  @@index([userId])
  @@index([opportunityId])
  @@index([lastSavedAt])
}

model CalculatorProgress {
  id             String   @id @default(uuid())
  userId         String
  opportunityId  String
  calculatorType String
  data           Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId, calculatorType])
  @@index([userId])
  @@index([opportunityId])
  @@index([calculatorType])
  @@index([updatedAt])
}

model SystemSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  category    String   @default("general")
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([category])
}

model DocuSealSubmission {
  id                String               @id @default(uuid())
  opportunityId     String
  documentType      DocuSealDocumentType
  templateId        String
  submissionId      String
  signingUrl        String?
  status            String               @default("pending")
  signedDocumentUrl String?
  customerName      String?
  customerEmail     String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  completedAt       DateTime?

  @@unique([opportunityId, documentType])
  @@index([opportunityId])
  @@index([submissionId])
  @@index([documentType])
  @@index([status])
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum SourceChannel {
  MANUAL
  AI
  OTHER
}

enum OpportunityStatus {
  IN_PROGRESS
  COMPLETED
  PAUSED
  CANCELLED
}

enum StepType {
  INITIAL_CONTACT
  SURVEY_SCHEDULING
  SITE_SURVEY
  PROPOSAL_GENERATION
  CONTRACT_SIGNING
  EXPRESS_CONSENT
  INSTALLATION_SCHEDULING
  FOLLOW_UP
  CALCULATOR
  OPEN_SOLAR
  PAYMENT
  PRICING
  FINISH_APPOINTMENT
  WELCOME_EMAIL
  INSTALLATION_BOOKING
  SOLAR_PROJECTION
  EMAIL_CONFIRMATION
}

enum StepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum SurveyStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  SUBMITTED
  APPROVED
  REJECTED
}

enum UserRole {
  ADMIN
  SURVEYOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum OpportunityOutcomeType {
  WON
  LOST
  ABANDONED
  CANCELLED
  IN_PROGRESS
}

enum DocuSealDocumentType {
  CONTRACT
  DISCLAIMER
  BOOKING_CONFIRMATION
  EXPRESS_CONSENT
}
